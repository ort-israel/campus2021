var exaportViewEdit,newItem=null,lastclicked=null;define(["jquery","block_exaport/jquery.json","jqueryui","block_exaport/touchpunch","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){function g(){a(".portfolioOptions li").removeClass("selected"),a(".portfolioDesignBlocks > li").each(function(){a(".portfolioOptions li[itemid="+a(this).data("portfolio").itemid+"]").addClass("selected")})}function h(){var b=[];a(".portfolioDesignBlocks").each(function(c){a(this).children("li:visible").not(".block-placeholder").each(function(d){b.push(a.extend(a(this).data("portfolio"),{positionx:c+1,positiony:d+1}))})});var c=a("form :input[name=blocks]");c.val(a.toJSON(b))}function i(b,c){var d;"new"==b?(d=a("<li></li>"),d.data("portfolio",c)):(d=a(c),c=d.data("portfolio"),c||(c={},d.attr("itemid")?(c.type="item",c.itemid=d.attr("itemid")):(c.type=d.attr("block-type"),d.attr("text")&&(c.text=d.attr("text")),d.attr("block_title")&&(c.block_title=d.attr("block_title")),d.attr("firstname")&&(c.firstname=d.attr("firstname")),d.attr("lastname")&&(c.lastname=d.attr("lastname")),d.attr("picture")&&(c.picture=d.attr("picture")),d.attr("email")&&(c.email=d.attr("email"))),d.data("portfolio",c))),d.addClass("item"),d.css("position","relative");if(c.itemid&&!c.item&&portfolioItems&&portfolioItems[c.itemid]&&(c.item=portfolioItems[c.itemid]),"item"==c.type&&c.itemid&&c.item){var e=c.item,f=e.link;""!=f&&(f=$E.translate("link")+": "+f+"<br />");var g="";if(e.filescount>1){var i=40;e.filescount>3&&(i=35),e.filescount>5&&(i=30),g+='<div class="pictureset" style="float:right; position: relative; text-align: right; max-width: 150px;">';for(var k=0;k<e.filescount;k++)k&&k%5===0&&(g+="<br />"),g+='<div class="picture" style="float:right; height: '+i+"px; width: "+i+'px;">',g+='<img style="max-width: 100%; max-height: 100%;" src="'+M.cfg.wwwroot+"/blocks/exaport/item_thumb.php?item_id="+e.id+"&imindex="+k+'">',g+="</div>";g+="</div>"}else g+='<div class="picture" style="float:right; position: relative; height: 100px; width: 100px;">',g+='<img style="max-width: 100%; max-height: 100%;" src="'+M.cfg.wwwroot+"/blocks/exaport/item_thumb.php?item_id="+e.id+'">',g+="</div>";var m="";m+='<div id="id_holder" style="display:none;"></div> ',m+='<div class="item_info" style="overflow: hidden;">',m+='<div class="header">'+$E.translate("viewitem")+": "+e.name+"</div>",m+=g,m+='<div class="body">'+$E.translate("type")+": "+$E.translate(e.type)+"<br />",m+=$E.translate("category")+": "+e.category+"<br />"+f,m+=$E.translate("comments")+": "+e.comments+'<div class="exaport-item-intro"></div>',e.competences&&(m+='<script type="text/javascript" src="javascript/wz_tooltip.js"></script><a onmouseover="Tip(\''+e.competences+'\')" onmouseout="UnTip()"><img src="'+M.cfg.wwwroot+'/pix/t/grades.png" class="iconsmall" alt="competences" /></a>'),m+="</div></div>",d.html(m),e.competences||d.find(".exaport-item-intro").html(e.intro)}else if("personal_information"==c.type){var m='<div id="id_holder" style="display:none;"></div>';m+='<div class="personal_info" style="overflow: hidden;">',m+='<div class="header">'+$E.translate("personalinformation")+": </div>",m+='<div class="picture" style="float:right; position: relative;"></div>',m+='<div class="name"></div>',m+='<div class="email"></div>',m+='<div class="body"></div>',m+="</div>",d.html(m),d.find("div.header").append(c.block_title),""!=c.picture&&null!=c.picture&&d.find("div.picture").append('<img src="'+c.picture+'">'),d.find("div.name").append(c.firstname),d.find("div.name").append(" "),d.find("div.name").append(c.lastname),d.find("div.email").append(c.email),d.find("div.body").append(c.print_text)}else if("headline"==c.type){var m='<div id="id_holder" style="display:none;"></div>';m+='<div class="header">'+$E.translate("view_specialitem_headline")+'<div class="body"></div></div>',d.html(m),d.find("div.body").append(c.print_text)}else if("media"==c.type){var m='<div id="id_holder" style="display:none;"></div>';m+='<div class="header"></div><div class="body"></div>',d.html(m),d.find("div.header").append($E.translate("view_specialitem_media")+(a.trim(c.block_title).length?": "+c.block_title:"")),d.find("div.body").append(c.contentmedia)}else if("badge"==c.type)if("undefined"==typeof c.badge)d.html("loading");else{var n=c.badge,m='<div id="id_holder" style="display:none;"></div>';m+='<div class="item_info" style="overflow: hidden;">',m+='<div class="header">'+$E.translate("view_specialitem_badge")+": "+n.name+"</div>",m+='<div class="picture" style="float:right; position: relative; height: 100px; width: 100px;">',m+='<img style="max-width: 100%; max-height: 100%;" src="'+n.imageUrl+'">',m+="</div>",m+='<div class="body">'+n.description+"</div>",d.html(m)}else if("cv_information"==c.type){c.item=null;var o="",p="",q=[];switch(c.resume_itemtype){case"edu":if(p=$E.translate("cofigureblock_cvinfo_education_history"),c.itemid&&resumeItems&&resumeItems.educations[c.itemid]){e=resumeItems.educations[c.itemid],q=e.attachments;var r="";r+='<span class="edu_institution">'+e.institution+":</span> ",r+='<span class="edu_qualname">'+e.qualname+"</span>",""==e.startdate&&""==e.enddate||(r+=" (",""!=e.startdate&&(r+='<span class="edu_startdate">'+e.startdate+"</span>"),""!=e.enddate&&(r+='<span class="edu_enddate"> - '+e.enddate+"</span>"),r+=")"),""!=e.qualdescription&&(r+='<span class="edu_qualdescription">'+e.qualdescription+"</span>"),o=r}break;case"employ":if(p=$E.translate("cofigureblock_cvinfo_employment_history"),c.itemid&&resumeItems&&resumeItems.employments[c.itemid]){e=resumeItems.employments[c.itemid],q=e.attachments;var r="";r+='<span class="employ_jobtitle">'+e.jobtitle+":</span> ",r+='<span class="employ_employer">'+e.employer+"</span>",""==e.startdate&&""==e.enddate||(r+=" (",""!=e.startdate&&(r+='<span class="employ_startdate">'+e.startdate+"</span>"),""!=e.enddate&&(r+='<span class="employ_enddate"> - '+e.enddate+"</span>"),r+=")"),""!=e.positiondescription&&(r+='<span class="employ_positiondescription">'+e.positiondescription+"</span>"),o=r}break;case"certif":if(p=$E.translate("cofigureblock_cvinfo_certif"),c.itemid&&resumeItems&&resumeItems.certifications[c.itemid]){e=resumeItems.certifications[c.itemid],q=e.attachments;var r="";r+='<span class="certif_title">'+e.title+"</span> ",""!=e.date&&(r+='<span class="certif_date">('+e.date+")</span>"),""!=e.description&&(r+='<span class="certif_description">'+e.description+"</span>"),o=r}break;case"public":if(p=$E.translate("cofigureblock_cvinfo_public"),c.itemid&&resumeItems&&resumeItems.publications[c.itemid]){e=resumeItems.publications[c.itemid],q=e.attachments;var r="";r+='<span class="public_title">'+e.title,""!=e.contribution&&(r+=" ("+e.contribution+")"),r+="</span> ",""!=e.date&&(r+='<span class="public_date">('+e.date+")</span>"),""==e.contributiondetails&&""==e.url||(r+='<span class="public_description">',""!=e.contributiondetails&&(r+=e.contributiondetails),""!=e.url&&(r+='<br /><a href="'+e.url+'" class="public_url" target="_blank">'+e.url+"</a>"),r+="</span>"),o=r}break;case"mbrship":if(p=$E.translate("cofigureblock_cvinfo_mbrship"),c.itemid&&resumeItems&&resumeItems.profmembershipments[c.itemid]){e=resumeItems.profmembershipments[c.itemid],q=e.attachments;var r="";r+='<span class="mbrship_title">'+e.title+"</span> ",""==e.startdate&&""==e.enddate||(r+=" (",""!=e.startdate&&(r+='<span class="mbrship_startdate">'+e.startdate+"</span>"),""!=e.enddate&&(r+='<span class="mbrship_enddate"> - '+e.enddate+"</span>"),r+=")"),""!=e.description&&(r+='<span class="mbrship_description">'+e.description+"</span>"),o=r}break;case"goalspersonal":case"goalsacademic":case"goalscareers":case"skillspersonal":case"skillsacademic":case"skillscareers":q=resumeItems[c.resume_itemtype+"_attachments"],console.log(resumeItems),console.log(c.resume_itemtype+"_attachments"),p=$E.translate("resume_"+c.resume_itemtype);var r="";resumeItems[""+c.resume_itemtype]&&(r+='<span class="'+c.resume_itemtype+'_text">'+resumeItems[""+c.resume_itemtype]+"</span> "),o=r;break;case"interests":p=$E.translate("cofigureblock_cvinfo_interests");var r="";""!=resumeItems.interests&&(r+='<span class="interests">'+resumeItems.interests+"</span> "),o=r}"1"==c.resume_withfiles&&q&&q.length&&(o+='<ul class="resume_attachments '+c.resume_itemtype+'_attachments">',a.each(q,function(a,b){o+='<li><a href="'+b.fileurl+'" target="_blank">'+b.filename+"</a></li>"}),o+="</ul>");var m='<div id="id_holder" style="display:none;"></div>';m+='<div class="cv_info" style="overflow: hidden;">',m+='<div class="header">'+$E.translate("cvinformation")+": "+p+"</div>",m+='<div class="body">'+o+"</div>",m+="</div>",d.html(m)}else{c.type="text";var m='<div id="id_holder" style="display:none;"></div>';m+='<div class="header"></div>',m+='<div class="body"><p class="text" '+$E.translate("view_specialitem_text_defaulttext")+'"></p></div>',d.html(m),d.find("div.header").append($E.translate("view_specialitem_text")+(a.trim(c.block_title).length?": "+c.block_title:"")),d.find("div.body").append(c.print_text)}if(d.find(":input[default-text]").focus(function(){a(this).removeClass("default-text"),a(this).attr("default-text")==a(this).val()&&a(this).val("")}).blur(function(){a.trim(a(this).val())||(a(this).addClass("default-text"),a(this).val(a(this).attr("default-text")))}).blur(),d.find("div#id_holder").append(c.id),"new"==b){var s=["item","badge","cv_information"];s.indexOf(c.type)>-1||a('<a class="edit" title="Edit"><span>Edit</span></a>').prependTo(d).click(l)}else d.append('<a class="unsaved" title="This block was not saved"><span>Unsaved</span></a>');return a('<a class="delete" title="'+$E.translate("delete")+'"><span>'+$E.translate("delete")+"</span></a>").prependTo(d).click(j),d.find(":input").change(function(){d.data("portfolio").text=a(this).val()}),h(),1==c.unshared&&(d.find("div.item_info").addClass("unshared_block"),$item_header=d.find("div.header").html(),d.find("div.header").html($item_header+'<span class="unshared_message">Unshared</span>')),d}function j(){a(this).parents(".item").remove(),g(),h()}function k(){var b=a("form#view_edit_form").serializeArray();b.push({name:"ajax",value:1}),m(a("#view-preview"),"",!0),a.ajax({url:document.location.href,type:"POST",data:b,success:function(b){var c=JSON.parse(b);a("form :input[name=blocks]").val(c.blocks),exaportViewEdit.resetViewContent(),n(a("#view-preview"),"")}})}function l(){var b=a(this).parent().find("#id_holder").html();lastclicked=a(this).parent(),m(lastclicked,"",!1),a.ajax({url:M.cfg.wwwroot+"/blocks/exaport/blocks.json.php",type:"POST",data:{item_id:b,action:"edit",viewid:a("form :input[name=viewid]").val(),"text[itemid]":a("form :input[name=draft_itemid]").val(),sesskey:a("form :input[name=sesskey]").val()},success:function(a){var b=JSON.parse(a);o(b.modalTitle,b.html)}})}function m(b,c,d){var e="preloader"+a.now(),f='<div id="'+e+'" class="preloader '+(d?"preloader-fixed":"")+' js-preloader flex-center"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';""!=c&&b.find(c).hide(),b.append(f),setTimeout("$('#"+e+"').remove();",15e3)}function n(b,c){""!=c&&a(b).find(".blocktype").show(),a(b).find(".preloader").remove()}function o(b,c){q?(q.setTitle(b),q.setBody(c),q.show()):e.create(r).done(function(d){q=d,q.setTitle(b),q.setBody(c),q.show(),q.getRoot().on(f.shown,function(){n(newItem,".blocktype"),n(lastclicked,""),console.log("modal is shown")}),q.getRoot().on(f.hidden,function(){q.setBody(""),newItem&&a(newItem).remove()})})}function p(){var b="",c=a("#exaport-view-mod");c.find(":input[name=externaccess]").is(":checked")?(b+=$E.translate("externalaccess")+" ",a("#externaccess-settings").show()):a("#externaccess-settings").hide(),c.find(":input[name=internaccess]").is(":checked")?(a("#internaccess-settings").show(),a("#internaccess-groups").hide(),b&&(b+=" "+$E.translate("viewand")+" "),b+=$E.translate("internalaccess")+": ",1==c.find(":input[name=shareall]:checked").val()?(b+=$E.translate("internalaccessall"),a("#internaccess-users").hide(),a("#internaccess-groups").hide()):2==c.find(":input[name=shareall]:checked").val()?(b+=$E.translate("internalaccessgroups"),a("#internaccess-users").hide(),a("#internaccess-groups").show(),ExabisEportfolio.load_grouplist("views_mod")):(b+=$E.translate("internalaccessusers"),a("#internaccess-groups").hide(),a("#internaccess-users").show(),ExabisEportfolio.load_userlist("views_mod"))):a("#internaccess-settings").hide(),c.find(":input[name=sharedemails]").is(":checked")?(b&&(b+=" "+$E.translate("viewand")+" "),b+=$E.translate("emailaccess")+" ",a("#emailaccess-settings").show()):a("#emailaccess-settings").hide(),b||(b=$E.translate("view_sharing_noaccess")),a("#view-share-text").html(b)}var q,r={title:"test title",body:"",footer:""},s=function(){var b={resetViewContent:function(){var b=a("form :input[name=blocks]").val();b&&(b=a.parseJSON(b));var c=a("form :input[name=myresume]").val();c&&(c=a.parseJSON(c)),b||(b=[{type:"headline"}]);var d=a(".portfolioDesignBlocks");d.empty(),a.each(b,function(){i("new",this).appendTo(this.positionx&&d[this.positionx-1]?d[this.positionx-1]:d[0])}),g(),h()},initAddItems:function(b){a("#add-items-list .add-item").click(function(b){var c=a(this).find("input");a(b.target).is(":input")||c.prop("checked",!c.prop("checked")),c.prop("checked")?a(this).addClass("checked"):a(this).removeClass("checked")})},addPersonalInfo:function(b){if(this.checkFields()){b!=-1&&(newItem=lastclicked);var c={};c.type="personal_information",c.id=b,c.block_title=a("#block_title").val();var d=a('.pieform input[name="fields[firstname]"]').first();void 0!==d&&d.is(":checked")&&(c.firstname=d.val());var e=a('.pieform input[name="fields[lastname]"]').first();if(e.is(":checked")&&(c.lastname=e.val()),c.picture=a("form input[name=picture]:checked").val(),c.email=a("form input[name=email]:checked").val(),c.text=a("#id_block_intro").val(),a(".mceEditor iframe").length){var f=a(".mceEditor iframe"),g=a("#tinymce",f.contents());g.length&&(c.text=g.html())}newItem.data("portfolio",c),i("update",a(newItem)),q.hide(),newItem=null,k()}},addHeadline:function(b){this.checkFields()&&(b!=-1&&(newItem=lastclicked),data={},data.text=a("#headline").val(),data.type="headline",data.id=b,newItem.data("portfolio",data),i("update",a(newItem)),newItem=null,q.hide(),k())},addText:function(b){if(this.checkFields()){if(b!=-1&&(newItem=lastclicked),data={},data.type="text",data.id=b,data.block_title=a("#block_title").val(),data.text=a("#id_block_text").val(),a(".mceEditor iframe").length){var c=a(".mceEditor iframe"),d=a("#tinymce",c.contents());d.length&&(data.text=d.html())}newItem.data("portfolio",data),i("update",a(newItem)),q.hide(),newItem=null,k()}},addItem:function(b){if(this.checkFields()){b!=-1&&(newItem=lastclicked);var c=0;a("#blockform input.add-item-checkbox:checked").each(function(){if(c+=1,c>1){var b=a(newItem).clone();newItem.after(b),newItem=b}data={},data.type="item",data.itemid=a(this).val(),newItem.data("portfolio",data),i("update",a(newItem))}),q.hide(),newItem=null,k()}},addCvInfo:function(b){if(this.checkFields()){b!=-1&&(newItem=lastclicked);var c=0;a("#blockform input.add-cvitem-checkbox:checked").each(function(){if(c+=1,c>1){var b=a(newItem).clone();newItem.after(b),newItem=b}data={},data.type="cv_information",data.itemid=a(this).val(),a('#blockform [name="add_withfiles"]').is(":checked")?data.resume_withfiles=1:data.resume_withfiles=0,data.resume_itemtype=a(this).attr("data-cvtype");var d=["goalspersonal","goalsacademic","goalcareers","skillspersonal","skillsacademic","skillscareers"];d.indexOf(data.resume_itemtype)>-1&&(data.itemid=null),newItem.data("portfolio",data),i("update",a(newItem))}),q.hide(),newItem=null,k()}},addMedia:function(b){this.checkFields()&&(b!=-1&&(newItem=lastclicked),data={},data.block_title=a("#block_title").val(),data.type="media",data.contentmedia=a("#block_media").val(),data.width=a("#block_width").val(),data.height=a("#block_height").val(),data.create_as_note=a("input[name=create_as_note]:checked").length?1:0,data.id=b,newItem.data("portfolio",data),i("update",a(newItem)),q.hide(),newItem=null,k())},addBadge:function(b){if(this.checkFields()){b!=-1&&(newItem=lastclicked);var c=0;a('#blockform input[name="add_badges[]"]:checked').each(function(){if(c+=1,c>1){var b=a(newItem).clone();newItem.after(b),newItem=b}data={},data.type="badge",data.itemid=a(this).val(),newItem.data("portfolio",data),i("update",a(newItem))}),q.hide(),newItem=null,k()}},checkFields:function(){var b=!0;return a("#blockform .not-empty-check").each(function(){var c=a(this).attr("for"),d=a("#blockform").find('input[name="'+c+'"]');return 0==d.length?void a(this).hide():d.val().length?void a(this).hide():(a(this).show(),d.focus(),b=!1,!1)}),b},filterItemsByTag:function(){a("#filterByTitle").val(""),a("div.add-item-category").hide(),a("div.add-item").show(),a("div.add-item-sub").show(),a("tr.sharedArtefacts").show();var b=a(".tagfilter").val();""!=b?a("div.add-item").each(function(){var c=a(this).data("tags");void 0!==c?c.indexOf(b)==-1&&a(this).hide():a(this).hide()}):a("div.add-item-category, div.add-item-sub").show(),a("div.add-item-sub").each(function(){0==a(this).find("div.add-item:visible").length&&a(this).hide()}),a("div.add-item:visible").each(function(){var b=a(this).data("category");a('div.add-item-category[data-category="'+b+'"]').show()}),0==a('div.add-item[data-category="sharedFromUser"]:visible').length&&a("tr.sharedArtefacts").hide()},filterItemsByTitle:function(){a(".tagfilter").length&&(a(".tagfilter")[0].selectedIndex=0);var b=a("#blockform #filterByTitle").val().toLowerCase();a("div.add-item-category").hide(),a("div.add-item").show(),a("div.add-item-sub").show(),a("tr.sharedArtefacts").show(),""!=b?a("div.add-item:visible").each(function(){var c=a(this).text();c.toLowerCase().indexOf(b)>-1?a(this).show():a(this).hide()}):a("div.add-item-category, div.add-item-sub").show(),a("div.add-item-sub").each(function(){0==a(this).find("div.add-item:visible").length&&a(this).hide()}),a("div.add-item:visible").each(function(){var b=a(this).data("category");a('div.add-item-category[data-category="'+b+'"]').show()}),0==a('div.add-item[data-category="sharedFromUser"]:visible').length&&a("tr.sharedArtefacts").hide()},clearItemFilters:function(){a(".tagfilter").length&&(a(".tagfilter")[0].selectedIndex=0),a("#blockform #filterByTitle").val(""),exaportViewEdit.filterItemsByTitle()},cancelAddEdit:function(){q.hide(),h()}};return b},t=function(){exaportViewEdit=s(),exaportViewEdit.resetViewContent(),a(".portfolioDesignBlocks").sortable({beforeStop:function(a,b){newItem=b.item},receive:function(b,c){console.log("start to modal!");var d=a(c.item[0]).closest("ul").prop("className");d.search("portfolioDesignBlocks")==-1&&(a.ajax({url:M.cfg.wwwroot+"/blocks/exaport/blocks.json.php",type:"POST",data:{type_block:c.item.attr("block-type"),action:"add",viewid:a("form :input[name=viewid]").val(),"text[itemid]":a("form :input[name=draft_itemid]").val(),sesskey:a("form :input[name=sesskey]").val()},success:function(b){var c=JSON.parse(b);o(c.modalTitle,c.html),a("#temp_javascript").remove();var d=document.createElement("script");a(d).attr("id","temp_javascript"),d.textContent=c.script,document.body.appendChild(d),a("body").on("change keydown paste input","#filterByTitle",exaportViewEdit.filterItemsByTitle)}}),h())},update:function(a,b){h()},handle:".header",placeholder:"block-placeholder",forcePlaceholderSize:!0,connectWith:[".portfolioDesignBlocks"]}),a(".portfolioOptions").sortable({connectWith:[".portfolioDesignBlocks"],placeholder:"block-placeholder",forcePlaceholderSize:!0,stop:function(a,b){resetElements()}}),a(".portfolioElement").draggable({connectToSortable:".portfolioDesignBlocks",placeholder:".block-placeholder",forcePlaceholderSize:!0,helper:"clone",stop:function(b,c){m(a(c.helper),"",!1)}})};return{initialise:function(b){t(),a(".view-sharing input[type=checkbox], .view-sharing input[type=radio]").click(p),p()}}});